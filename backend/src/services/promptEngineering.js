/**\n * PromptEngineering - Advanced prompt generation and optimization service\n * Provides specialized prompt templates and dynamic adjustments based on product analysis\n */\nclass PromptEngineering {\n  constructor() {\n    this.garmentTypes = {\n      'tshirt': {\n        keywords: ['t-shirt', 'tee', 'shirt', 'top'],\n        characteristics: ['casual', 'comfortable', 'fitted', 'relaxed'],\n        focusAreas: ['neckline', 'sleeves', 'fit', 'hem']\n      },\n      'hoodie': {\n        keywords: ['hoodie', 'sweatshirt', 'pullover'],\n        characteristics: ['cozy', 'oversized', 'casual', 'warm'],\n        focusAreas: ['hood', 'kangaroo pocket', 'drawstrings', 'cuffs']\n      },\n      'polo': {\n        keywords: ['polo', 'collared shirt'],\n        characteristics: ['smart casual', 'structured', 'professional'],\n        focusAreas: ['collar', 'placket', 'buttons', 'fit']\n      },\n      'tank': {\n        keywords: ['tank top', 'sleeveless', 'vest'],\n        characteristics: ['athletic', 'casual', 'fitted'],\n        focusAreas: ['armholes', 'neckline', 'fit']\n      },\n      'dress': {\n        keywords: ['dress', 'gown', 'frock'],\n        characteristics: ['elegant', 'flowing', 'feminine'],\n        focusAreas: ['silhouette', 'length', 'neckline', 'waistline']\n      },\n      'jacket': {\n        keywords: ['jacket', 'blazer', 'coat'],\n        characteristics: ['structured', 'professional', 'layered'],\n        focusAreas: ['lapels', 'buttons', 'pockets', 'shoulders']\n      }\n    };\n\n    this.brandingTypes = {\n      'embroidery': {\n        characteristics: ['raised', 'textured', 'dimensional', 'stitched'],\n        enhancement: 'with detailed embroidered design showing thread texture and dimensional quality',\n        focus: 'clearly visible embroidered logo with realistic thread texture'\n      },\n      'screen_printing': {\n        characteristics: ['flat', 'smooth', 'printed', 'graphic'],\n        enhancement: 'with crisp screen-printed design showing smooth finish and vibrant colors',\n        focus: 'sharp and clear screen-printed logo with vibrant colors'\n      },\n      'heat_transfer': {\n        characteristics: ['vinyl', 'smooth', 'matte', 'glossy'],\n        enhancement: 'with heat-transfer vinyl design showing clean edges and professional finish',\n        focus: 'precise heat-transfer logo with clean edges and proper adhesion'\n      },\n      'sublimation': {\n        characteristics: ['integrated', 'seamless', 'vibrant', 'permanent'],\n        enhancement: 'with sublimated design fully integrated into fabric fibers',\n        focus: 'seamlessly integrated sublimated design with vibrant colors'\n      }\n    };\n\n    this.modelCharacteristics = {\n      'johny': {\n        physique: 'athletic build, broad shoulders',\n        style: 'casual confident pose',\n        features: 'strong jawline, friendly expression'\n      },\n      'nyoman': {\n        physique: 'lean athletic build',\n        style: 'relaxed natural pose',\n        features: 'warm smile, approachable demeanor'\n      },\n      'isabella': {\n        physique: 'elegant proportions',\n        style: 'graceful confident pose',\n        features: 'expressive eyes, natural beauty'\n      }\n    };\n\n    this.poseInstructions = {\n      'Arms Crossed': {\n        description: 'arms firmly crossed over chest',\n        emphasis: 'confident stance with arms crossed, maintaining natural shoulder position',\n        considerations: 'ensure garment draping is natural around crossed arms'\n      },\n      'Contrapposto': {\n        description: 'classic contrapposto stance with weight shifted to one leg',\n        emphasis: 'elegant weight shift creating natural body curve and relaxed posture',\n        considerations: 'maintain garment fit and draping with shifted weight'\n      },\n      'Clasping Hands': {\n        description: 'hands clasped together in front of body',\n        emphasis: 'hands naturally clasped at waist level, relaxed shoulders',\n        considerations: 'ensure hands positioning doesn\\'t distort garment front'\n      },\n      'Hands On Chest': {\n        description: 'hands positioned on chest area',\n        emphasis: 'hands gently placed on chest, showcasing garment front details',\n        considerations: 'hands should highlight, not obscure, garment features'\n      },\n      'Holding One Arm': {\n        description: 'one arm held by the other hand',\n        emphasis: 'natural arm positioning with gentle hold, relaxed posture',\n        considerations: 'maintain natural garment draping on both arms'\n      },\n      'Hands in Pockets': {\n        description: 'hands casually placed in pockets',\n        emphasis: 'relaxed casual stance with hands in pockets, natural shoulder position',\n        considerations: 'ensure pocket positioning is natural and garment fit is maintained'\n      }\n    };\n  }\n\n  /**\n   * Generate stage 1 prompt for model consistency\n   * @param {Object} params - Generation parameters\n   * @returns {string} Optimized stage 1 prompt\n   */\n  generateStage1Prompt(params) {\n    const { modelId, pose, productAnalysis, qualityTier } = params;\n    \n    const modelChar = this.modelCharacteristics[modelId] || this.modelCharacteristics['johny'];\n    const poseInfo = this.poseInstructions[pose] || this.poseInstructions['Arms Crossed'];\n    \n    let prompt = `Professional studio photograph of Indonesian model with ${modelChar.physique}, `;\n    prompt += `${modelChar.features}, in ${poseInfo.description}. `;\n    prompt += `${poseInfo.emphasis}. `;\n    \n    // Add quality-specific enhancements\n    if (qualityTier === 'ultra') {\n      prompt += 'Ultra-high resolution, perfect lighting, professional photography, ';\n      prompt += 'maintaining exact facial features and body proportions, ';\n    } else if (qualityTier === 'premium') {\n      prompt += 'High quality studio lighting, professional photography, ';\n      prompt += 'consistent facial features and natural pose, ';\n    }\n    \n    prompt += 'clean white background, soft even lighting, ';\n    prompt += 'photorealistic, detailed, sharp focus, ';\n    prompt += 'maintaining model identity and characteristics perfectly';\n    \n    return prompt;\n  }\n\n  /**\n   * Generate stage 2 prompt for product application\n   * @param {Object} params - Generation parameters\n   * @returns {string} Optimized stage 2 prompt\n   */\n  generateStage2Prompt(params) {\n    const { modelId, pose, productAnalysis, qualityTier, stage1ImagePath } = params;\n    \n    const garmentType = this.detectGarmentType(productAnalysis);\n    const brandingType = this.detectBrandingType(productAnalysis);\n    \n    let prompt = 'Professional product photography showing the exact same person ';\n    prompt += `wearing ${this.buildGarmentDescription(garmentType, productAnalysis)}. `;\n    \n    // Add branding enhancement\n    if (brandingType && productAnalysis.branding) {\n      const brandingConfig = this.brandingTypes[brandingType];\n      prompt += `${brandingConfig.enhancement}. `;\n      prompt += `${brandingConfig.focus}. `;\n    }\n    \n    // Add color accuracy emphasis\n    if (productAnalysis.colors && productAnalysis.colors.dominant) {\n      const colorDesc = this.generateColorDescription(productAnalysis.colors.dominant);\n      prompt += `Exact ${colorDesc} color matching the original product. `;\n    }\n    \n    // Add garment-specific details\n    const garmentConfig = this.garmentTypes[garmentType];\n    if (garmentConfig) {\n      prompt += `Perfect ${garmentConfig.characteristics.join(', ')} fit. `;\n      prompt += `Attention to ${garmentConfig.focusAreas.join(', ')} details. `;\n    }\n    \n    // Add pose considerations\n    const poseInfo = this.poseInstructions[pose];\n    if (poseInfo && poseInfo.considerations) {\n      prompt += `${poseInfo.considerations}. `;\n    }\n    \n    // Quality tier enhancements\n    if (qualityTier === 'ultra') {\n      prompt += 'Ultra-high resolution, perfect fabric texture, exact color reproduction, ';\n      prompt += 'professional studio lighting, maintaining perfect model consistency, ';\n    } else if (qualityTier === 'premium') {\n      prompt += 'High quality fabric texture, accurate colors, professional lighting, ';\n      prompt += 'maintaining model appearance, ';\n    }\n    \n    prompt += 'photorealistic, detailed, sharp focus, clean background, ';\n    prompt += 'preserving exact facial features and body proportions from reference';\n    \n    return prompt;\n  }\n\n  /**\n   * Generate enhancement prompts for specific issues\n   * @param {Object} params - Enhancement parameters\n   * @returns {Object} Enhancement prompts\n   */\n  generateEnhancementPrompts(params) {\n    const { issueType, productAnalysis, modelId, pose } = params;\n    \n    const enhancements = {\n      face_consistency: this.generateFaceConsistencyPrompt(modelId),\n      pose_accuracy: this.generatePoseAccuracyPrompt(pose),\n      color_matching: this.generateColorMatchingPrompt(productAnalysis),\n      style_preservation: this.generateStylePreservationPrompt(productAnalysis),\n      branding_enhancement: this.generateBrandingEnhancementPrompt(productAnalysis)\n    };\n    \n    return issueType ? enhancements[issueType] : enhancements;\n  }\n\n  /**\n   * Detect garment type from product analysis\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string} Detected garment type\n   */\n  detectGarmentType(productAnalysis) {\n    if (!productAnalysis || !productAnalysis.description) {\n      return 'tshirt'; // default\n    }\n    \n    const description = productAnalysis.description.toLowerCase();\n    \n    for (const [type, config] of Object.entries(this.garmentTypes)) {\n      if (config.keywords.some(keyword => description.includes(keyword))) {\n        return type;\n      }\n    }\n    \n    return 'tshirt'; // default fallback\n  }\n\n  /**\n   * Detect branding type from product analysis\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string|null} Detected branding type\n   */\n  detectBrandingType(productAnalysis) {\n    if (!productAnalysis || !productAnalysis.branding) {\n      return null;\n    }\n    \n    const branding = productAnalysis.branding;\n    \n    // Check for embroidery indicators\n    if (branding.hasEmbroidery || \n        (branding.description && branding.description.toLowerCase().includes('embroid'))) {\n      return 'embroidery';\n    }\n    \n    // Check for screen printing indicators\n    if (branding.hasScreenPrint || \n        (branding.description && branding.description.toLowerCase().includes('print'))) {\n      return 'screen_printing';\n    }\n    \n    // Check for heat transfer indicators\n    if (branding.hasHeatTransfer || \n        (branding.description && branding.description.toLowerCase().includes('vinyl'))) {\n      return 'heat_transfer';\n    }\n    \n    // Check for sublimation indicators\n    if (branding.hasSublimation || \n        (branding.description && branding.description.toLowerCase().includes('sublim'))) {\n      return 'sublimation';\n    }\n    \n    return 'screen_printing'; // default for generic branding\n  }\n\n  /**\n   * Build detailed garment description\n   * @param {string} garmentType - Type of garment\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string} Detailed garment description\n   */\n  buildGarmentDescription(garmentType, productAnalysis) {\n    const garmentConfig = this.garmentTypes[garmentType] || this.garmentTypes['tshirt'];\n    let description = garmentConfig.keywords[0];\n    \n    // Add color information\n    if (productAnalysis.colors && productAnalysis.colors.dominant) {\n      const colorDesc = this.generateColorDescription(productAnalysis.colors.dominant);\n      description = `${colorDesc} ${description}`;\n    }\n    \n    // Add material information if available\n    if (productAnalysis.material) {\n      description += ` made of ${productAnalysis.material}`;\n    }\n    \n    // Add style characteristics\n    description += ` with ${garmentConfig.characteristics.join(', ')} style`;\n    \n    return description;\n  }\n\n  /**\n   * Generate color description from RGB values\n   * @param {Object} color - Color object with r, g, b values\n   * @returns {string} Color description\n   */\n  generateColorDescription(color) {\n    const { r, g, b } = color;\n    \n    // Define color ranges\n    const colors = [\n      { name: 'red', r: [200, 255], g: [0, 100], b: [0, 100] },\n      { name: 'green', r: [0, 100], g: [200, 255], b: [0, 100] },\n      { name: 'blue', r: [0, 100], g: [0, 100], b: [200, 255] },\n      { name: 'yellow', r: [200, 255], g: [200, 255], b: [0, 100] },\n      { name: 'orange', r: [255, 255], g: [100, 200], b: [0, 50] },\n      { name: 'purple', r: [150, 255], g: [0, 100], b: [150, 255] },\n      { name: 'pink', r: [255, 255], g: [150, 220], b: [150, 220] },\n      { name: 'brown', r: [100, 200], g: [50, 150], b: [0, 100] },\n      { name: 'gray', r: [100, 200], g: [100, 200], b: [100, 200] },\n      { name: 'black', r: [0, 50], g: [0, 50], b: [0, 50] },\n      { name: 'white', r: [200, 255], g: [200, 255], b: [200, 255] }\n    ];\n    \n    for (const colorDef of colors) {\n      const [rMin, rMax] = colorDef.r;\n      const [gMin, gMax] = colorDef.g;\n      const [bMin, bMax] = colorDef.b;\n      \n      if (r >= rMin && r <= rMax && g >= gMin && g <= gMax && b >= bMin && b <= bMax) {\n        return colorDef.name;\n      }\n    }\n    \n    // Fallback to brightness-based description\n    const brightness = (r + g + b) / 3;\n    if (brightness > 200) return 'light';\n    if (brightness < 80) return 'dark';\n    return 'medium-toned';\n  }\n\n  /**\n   * Generate face consistency enhancement prompt\n   * @param {string} modelId - Model identifier\n   * @returns {string} Face consistency prompt\n   */\n  generateFaceConsistencyPrompt(modelId) {\n    const modelChar = this.modelCharacteristics[modelId] || this.modelCharacteristics['johny'];\n    return `maintaining exact facial features: ${modelChar.features}, ` +\n           'preserving identical face structure, expression, and characteristics, ' +\n           'ensuring perfect facial consistency with reference image';\n  }\n\n  /**\n   * Generate pose accuracy enhancement prompt\n   * @param {string} pose - Target pose\n   * @returns {string} Pose accuracy prompt\n   */\n  generatePoseAccuracyPrompt(pose) {\n    const poseInfo = this.poseInstructions[pose] || this.poseInstructions['Arms Crossed'];\n    return `precise ${poseInfo.description}, ${poseInfo.emphasis}, ` +\n           `${poseInfo.considerations}, maintaining exact pose accuracy`;\n  }\n\n  /**\n   * Generate color matching enhancement prompt\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string} Color matching prompt\n   */\n  generateColorMatchingPrompt(productAnalysis) {\n    if (!productAnalysis.colors) {\n      return 'accurate color reproduction matching original product colors';\n    }\n    \n    const colorDesc = this.generateColorDescription(productAnalysis.colors.dominant);\n    return `exact ${colorDesc} color matching, precise color reproduction, ` +\n           'maintaining original product color accuracy and vibrancy';\n  }\n\n  /**\n   * Generate style preservation enhancement prompt\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string} Style preservation prompt\n   */\n  generateStylePreservationPrompt(productAnalysis) {\n    const garmentType = this.detectGarmentType(productAnalysis);\n    const garmentConfig = this.garmentTypes[garmentType] || this.garmentTypes['tshirt'];\n    \n    return `preserving original garment style and structure, ` +\n           `maintaining ${garmentConfig.characteristics.join(', ')} characteristics, ` +\n           `accurate ${garmentConfig.focusAreas.join(', ')} details, ` +\n           'keeping fabric texture and pattern integrity';\n  }\n\n  /**\n   * Generate branding enhancement prompt\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string} Branding enhancement prompt\n   */\n  generateBrandingEnhancementPrompt(productAnalysis) {\n    if (!productAnalysis.branding) {\n      return 'clear and visible branding elements';\n    }\n    \n    const brandingType = this.detectBrandingType(productAnalysis);\n    const brandingConfig = this.brandingTypes[brandingType] || this.brandingTypes['screen_printing'];\n    \n    let prompt = `${brandingConfig.focus}, ${brandingConfig.enhancement}, `;\n    \n    if (productAnalysis.branding.hasLogo) {\n      prompt += 'clearly visible and readable logo, ';\n    }\n    \n    if (productAnalysis.branding.hasText) {\n      prompt += 'sharp and legible text elements, ';\n    }\n    \n    prompt += 'maintaining branding quality and visibility';\n    \n    return prompt;\n  }\n\n  /**\n   * Optimize prompt based on previous validation results\n   * @param {string} basePrompt - Base prompt to optimize\n   * @param {Object} validationResult - Previous validation results\n   * @param {Object} productAnalysis - Product analysis data\n   * @returns {string} Optimized prompt\n   */\n  optimizePromptFromValidation(basePrompt, validationResult, productAnalysis) {\n    let optimizedPrompt = basePrompt;\n    \n    if (!validationResult || !validationResult.passDetails) {\n      return optimizedPrompt;\n    }\n    \n    const { passDetails } = validationResult;\n    \n    // Enhance face consistency if needed\n    if (passDetails.consistency && !passDetails.consistency.face) {\n      const faceEnhancement = this.generateFaceConsistencyPrompt('johny');\n      optimizedPrompt += `, ${faceEnhancement}`;\n    }\n    \n    // Enhance pose accuracy if needed\n    if (passDetails.consistency && !passDetails.consistency.pose) {\n      const poseEnhancement = this.generatePoseAccuracyPrompt('Arms Crossed');\n      optimizedPrompt += `, ${poseEnhancement}`;\n    }\n    \n    // Enhance color matching if needed\n    if (passDetails.accuracy && !passDetails.accuracy.color) {\n      const colorEnhancement = this.generateColorMatchingPrompt(productAnalysis);\n      optimizedPrompt += `, ${colorEnhancement}`;\n    }\n    \n    // Enhance style preservation if needed\n    if (passDetails.accuracy && !passDetails.accuracy.style) {\n      const styleEnhancement = this.generateStylePreservationPrompt(productAnalysis);\n      optimizedPrompt += `, ${styleEnhancement}`;\n    }\n    \n    // Enhance branding if needed\n    if (passDetails.accuracy && !passDetails.accuracy.branding) {\n      const brandingEnhancement = this.generateBrandingEnhancementPrompt(productAnalysis);\n      optimizedPrompt += `, ${brandingEnhancement}`;\n    }\n    \n    return optimizedPrompt;\n  }\n\n  /**\n   * Get prompt statistics and analysis\n   * @returns {Object} Prompt engineering statistics\n   */\n  getStatistics() {\n    return {\n      garmentTypes: Object.keys(this.garmentTypes).length,\n      brandingTypes: Object.keys(this.brandingTypes).length,\n      supportedModels: Object.keys(this.modelCharacteristics).length,\n      supportedPoses: Object.keys(this.poseInstructions).length,\n      version: '1.0.0'\n    };\n  }\n}\n\nmodule.exports = PromptEngineering;