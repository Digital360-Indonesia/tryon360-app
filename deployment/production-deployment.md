# Enhanced Try-On Consistency System - Production Deployment Guide\n\n## Overview\n\nThis guide provides step-by-step instructions for deploying the Enhanced Try-On Consistency System to production. The deployment includes backend services, frontend application, database setup, monitoring configuration, and feature flag management.\n\n## Pre-Deployment Checklist\n\n### System Requirements\n\n- [ ] **Server Specifications**:\n  - CPU: Minimum 8 cores, Recommended 16+ cores\n  - RAM: Minimum 16GB, Recommended 32GB+\n  - Storage: Minimum 100GB SSD, Recommended 500GB+ SSD\n  - Network: High-bandwidth connection for AI service APIs\n\n- [ ] **Software Dependencies**:\n  - Node.js 18+ LTS\n  - npm 9+\n  - PM2 process manager\n  - Nginx (reverse proxy)\n  - SSL certificates\n\n- [ ] **External Services**:\n  - OpenAI API access and valid API key\n  - FLUX API access and valid API key\n  - CDN configuration (optional but recommended)\n  - Monitoring service setup (e.g., DataDog, New Relic)\n\n### Security Requirements\n\n- [ ] **API Keys and Secrets**:\n  - All API keys stored in secure environment variables\n  - Database credentials secured\n  - JWT secrets generated and secured\n  - File upload directory permissions configured\n\n- [ ] **Network Security**:\n  - Firewall rules configured\n  - SSL/TLS certificates installed\n  - Rate limiting configured\n  - CORS policies set appropriately\n\n### Data and Backup\n\n- [ ] **Database Setup**:\n  - Production database configured\n  - Backup strategy implemented\n  - Migration scripts tested\n  - Data retention policies defined\n\n- [ ] **File Storage**:\n  - Upload directory configured with appropriate permissions\n  - Backup strategy for generated images\n  - CDN integration (if applicable)\n  - Cleanup policies for temporary files\n\n## Environment Configuration\n\n### Backend Environment Variables\n\nCreate `/backend/.env.production`:\n\n```bash\n# Application Configuration\nNODE_ENV=production\nPORT=3001\nFRONTEND_URL=https://your-domain.com\n\n# AI Service Configuration\nOPENAI_API_KEY=your_production_openai_key\nFLUX_API_KEY=your_production_flux_key\n\n# Quality Control Settings\nDEFAULT_QUALITY_TIER=standard\nMAX_RETRY_ATTEMPTS=5\nVALIDATION_TIMEOUT=60000\nGENERATION_TIMEOUT=300000\n\n# Performance Settings\nMAX_CONCURRENT_GENERATIONS=3\nQUEUE_MAX_SIZE=100\nCACHE_VALIDATION_RESULTS=true\nCACHE_TTL=3600000\n\n# File Upload Configuration\nUPLOAD_MAX_SIZE=10485760\nUPLOAD_ALLOWED_TYPES=image/jpeg,image/png,image/webp\nUPLOAD_DIR=/var/www/uploads\n\n# Database Configuration (if applicable)\nDATABASE_URL=your_database_connection_string\n\n# Monitoring and Logging\nENABLE_METRICS_TRACKING=true\nMETRICS_RETENTION_DAYS=90\nLOG_LEVEL=info\nLOG_FILE=/var/log/kustompedia-tryon/app.log\n\n# Security\nJWT_SECRET=your_secure_jwt_secret\nSESSION_SECRET=your_secure_session_secret\nCORS_ORIGIN=https://your-domain.com\n\n# Feature Flags\nENABLE_ENHANCED_GENERATION=true\nENABLE_ADAPTIVE_RETRY=true\nENABLE_QUALITY_VALIDATION=true\nENABLE_ANALYTICS=true\nENABLE_A_B_TESTING=false\n\n# Cost Management\nDAILY_COST_LIMIT=500.00\nPER_GENERATION_COST_LIMIT=2.00\nCOST_ALERT_THRESHOLD=400.00\n\n# Rate Limiting\nRATE_LIMIT_WINDOW=900000\nRATE_LIMIT_MAX_REQUESTS=100\nRATE_LIMIT_SKIP_SUCCESSFUL=false\n```\n\n### Frontend Environment Variables\n\nCreate `/frontend/.env.production`:\n\n```bash\n# API Configuration\nREACT_APP_API_BASE_URL=https://api.your-domain.com\nREACT_APP_WEBSOCKET_URL=wss://api.your-domain.com\n\n# Feature Flags\nREACT_APP_ENABLE_ENHANCED_FEATURES=true\nREACT_APP_ENABLE_ADMIN_DASHBOARD=true\nREACT_APP_ENABLE_ANALYTICS=true\n\n# Analytics and Monitoring\nREACT_APP_ANALYTICS_ID=your_analytics_id\nREACT_APP_ERROR_TRACKING_DSN=your_error_tracking_dsn\n\n# UI Configuration\nREACT_APP_MAX_UPLOAD_SIZE=10485760\nREACT_APP_SUPPORTED_FORMATS=jpeg,jpg,png,webp\nREACT_APP_DEFAULT_QUALITY_TIER=standard\n```\n\n## Deployment Scripts\n\n### 1. Backend Deployment Script\n\nCreate `/deployment/deploy-backend.sh`:\n\n```bash\n#!/bin/bash\n\n# Enhanced Try-On Backend Deployment Script\n\nset -e\n\necho \"üöÄ Starting Enhanced Try-On Backend Deployment...\"\n\n# Configuration\nAPP_NAME=\"kustompedia-tryon-backend\"\nAPP_DIR=\"/var/www/kustompedia-tryon-backend\"\nBACKUP_DIR=\"/var/backups/kustompedia-tryon\"\nLOG_DIR=\"/var/log/kustompedia-tryon\"\nUPLOAD_DIR=\"/var/www/uploads\"\n\n# Create necessary directories\nsudo mkdir -p $APP_DIR\nsudo mkdir -p $BACKUP_DIR\nsudo mkdir -p $LOG_DIR\nsudo mkdir -p $UPLOAD_DIR\n\n# Set permissions\nsudo chown -R $USER:$USER $APP_DIR\nsudo chown -R www-data:www-data $UPLOAD_DIR\nsudo chmod 755 $UPLOAD_DIR\n\n# Backup current deployment (if exists)\nif [ -d \"$APP_DIR/current\" ]; then\n    echo \"üì¶ Creating backup of current deployment...\"\n    sudo cp -r $APP_DIR/current $BACKUP_DIR/backup-$(date +%Y%m%d-%H%M%S)\nfi\n\n# Deploy new version\necho \"üì• Deploying new version...\"\ncp -r ./backend/* $APP_DIR/\n\n# Install dependencies\necho \"üì¶ Installing dependencies...\"\ncd $APP_DIR\nnpm ci --production\n\n# Run database migrations (if applicable)\necho \"üóÑÔ∏è Running database migrations...\"\n# npm run migrate:production\n\n# Create data directories\nmkdir -p $APP_DIR/data\nchmod 755 $APP_DIR/data\n\n# Copy environment configuration\ncp /deployment/.env.production $APP_DIR/.env\n\n# Validate configuration\necho \"‚úÖ Validating configuration...\"\nnode -e \"require('dotenv').config(); console.log('Environment loaded successfully');\"\n\n# Stop existing process\necho \"‚èπÔ∏è Stopping existing process...\"\npm2 stop $APP_NAME || true\n\n# Start new process\necho \"‚ñ∂Ô∏è Starting new process...\"\npm2 start $APP_DIR/server.js --name $APP_NAME --instances 2 --exec-mode cluster\n\n# Save PM2 configuration\npm2 save\n\n# Setup log rotation\necho \"üìù Setting up log rotation...\"\nsudo tee /etc/logrotate.d/kustompedia-tryon > /dev/null <<EOF\n$LOG_DIR/*.log {\n    daily\n    missingok\n    rotate 30\n    compress\n    delaycompress\n    notifempty\n    create 644 $USER $USER\n    postrotate\n        pm2 reload $APP_NAME\n    endscript\n}\nEOF\n\n# Health check\necho \"üè• Performing health check...\"\nsleep 10\nif curl -f http://localhost:3001/api/health; then\n    echo \"‚úÖ Backend deployment successful!\"\nelse\n    echo \"‚ùå Health check failed! Rolling back...\"\n    pm2 stop $APP_NAME\n    # Restore backup if available\n    if [ -d \"$BACKUP_DIR/backup-$(date +%Y%m%d)*\" ]; then\n        latest_backup=$(ls -t $BACKUP_DIR/backup-* | head -1)\n        cp -r $latest_backup/* $APP_DIR/\n        pm2 start $APP_DIR/server.js --name $APP_NAME\n    fi\n    exit 1\nfi\n\necho \"üéâ Backend deployment completed successfully!\"\n```\n\n### 2. Frontend Deployment Script\n\nCreate `/deployment/deploy-frontend.sh`:\n\n```bash\n#!/bin/bash\n\n# Enhanced Try-On Frontend Deployment Script\n\nset -e\n\necho \"üöÄ Starting Enhanced Try-On Frontend Deployment...\"\n\n# Configuration\nAPP_NAME=\"kustompedia-tryon-frontend\"\nAPP_DIR=\"/var/www/kustompedia-tryon-frontend\"\nBUILD_DIR=\"/tmp/kustompedia-tryon-build\"\nNGINX_SITES=\"/etc/nginx/sites-available\"\nNGINX_ENABLED=\"/etc/nginx/sites-enabled\"\n\n# Create build directory\nmkdir -p $BUILD_DIR\n\n# Copy source and build\necho \"üèóÔ∏è Building frontend application...\"\ncp -r ./frontend/* $BUILD_DIR/\ncd $BUILD_DIR\n\n# Install dependencies and build\nnpm ci\ncp /deployment/.env.production .env.production\nnpm run build\n\n# Backup current deployment\nif [ -d \"$APP_DIR\" ]; then\n    echo \"üì¶ Creating backup of current deployment...\"\n    sudo cp -r $APP_DIR /var/backups/frontend-backup-$(date +%Y%m%d-%H%M%S)\nfi\n\n# Deploy new build\necho \"üì• Deploying new build...\"\nsudo rm -rf $APP_DIR\nsudo mkdir -p $APP_DIR\nsudo cp -r $BUILD_DIR/build/* $APP_DIR/\n\n# Set permissions\nsudo chown -R www-data:www-data $APP_DIR\nsudo chmod -R 755 $APP_DIR\n\n# Configure Nginx\necho \"üîß Configuring Nginx...\"\nsudo tee $NGINX_SITES/kustompedia-tryon > /dev/null <<EOF\nserver {\n    listen 80;\n    listen [::]:80;\n    server_name your-domain.com www.your-domain.com;\n    return 301 https://\\$server_name\\$request_uri;\n}\n\nserver {\n    listen 443 ssl http2;\n    listen [::]:443 ssl http2;\n    server_name your-domain.com www.your-domain.com;\n\n    # SSL Configuration\n    ssl_certificate /etc/ssl/certs/your-domain.crt;\n    ssl_certificate_key /etc/ssl/private/your-domain.key;\n    ssl_protocols TLSv1.2 TLSv1.3;\n    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;\n    ssl_prefer_server_ciphers off;\n\n    # Security Headers\n    add_header X-Frame-Options \"SAMEORIGIN\" always;\n    add_header X-XSS-Protection \"1; mode=block\" always;\n    add_header X-Content-Type-Options \"nosniff\" always;\n    add_header Referrer-Policy \"no-referrer-when-downgrade\" always;\n    add_header Content-Security-Policy \"default-src 'self' http: https: data: blob: 'unsafe-inline'\" always;\n\n    # Root directory\n    root $APP_DIR;\n    index index.html;\n\n    # Gzip compression\n    gzip on;\n    gzip_vary on;\n    gzip_min_length 1024;\n    gzip_proxied expired no-cache no-store private must-revalidate auth;\n    gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;\n\n    # Static assets caching\n    location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)\\$ {\n        expires 1y;\n        add_header Cache-Control \"public, immutable\";\n    }\n\n    # API proxy\n    location /api/ {\n        proxy_pass http://localhost:3001;\n        proxy_http_version 1.1;\n        proxy_set_header Upgrade \\$http_upgrade;\n        proxy_set_header Connection 'upgrade';\n        proxy_set_header Host \\$host;\n        proxy_set_header X-Real-IP \\$remote_addr;\n        proxy_set_header X-Forwarded-For \\$proxy_add_x_forwarded_for;\n        proxy_set_header X-Forwarded-Proto \\$scheme;\n        proxy_cache_bypass \\$http_upgrade;\n        proxy_read_timeout 300s;\n        proxy_connect_timeout 75s;\n    }\n\n    # Upload files\n    location /uploads/ {\n        alias /var/www/uploads/;\n        expires 1d;\n        add_header Cache-Control \"public\";\n    }\n\n    # React Router (SPA)\n    location / {\n        try_files \\$uri \\$uri/ /index.html;\n    }\n\n    # Rate limiting\n    limit_req_zone \\$binary_remote_addr zone=api:10m rate=10r/s;\n    location /api/ {\n        limit_req zone=api burst=20 nodelay;\n    }\n}\nEOF\n\n# Enable site\nsudo ln -sf $NGINX_SITES/kustompedia-tryon $NGINX_ENABLED/\n\n# Test Nginx configuration\necho \"üß™ Testing Nginx configuration...\"\nsudo nginx -t\n\n# Reload Nginx\necho \"üîÑ Reloading Nginx...\"\nsudo systemctl reload nginx\n\n# Cleanup\nrm -rf $BUILD_DIR\n\necho \"‚úÖ Frontend deployment successful!\"\necho \"üåê Application available at: https://your-domain.com\"\n```\n\n### 3. Complete Deployment Script\n\nCreate `/deployment/deploy.sh`:\n\n```bash\n#!/bin/bash\n\n# Complete Enhanced Try-On System Deployment\n\nset -e\n\necho \"üöÄ Starting Complete Enhanced Try-On System Deployment...\"\n\n# Pre-deployment checks\necho \"üîç Running pre-deployment checks...\"\n\n# Check system requirements\nif ! command -v node &> /dev/null; then\n    echo \"‚ùå Node.js is not installed\"\n    exit 1\nfi\n\nif ! command -v npm &> /dev/null; then\n    echo \"‚ùå npm is not installed\"\n    exit 1\nfi\n\nif ! command -v pm2 &> /dev/null; then\n    echo \"‚ùå PM2 is not installed\"\n    exit 1\nfi\n\nif ! command -v nginx &> /dev/null; then\n    echo \"‚ùå Nginx is not installed\"\n    exit 1\nfi\n\n# Check environment files\nif [ ! -f \"/deployment/.env.production\" ]; then\n    echo \"‚ùå Backend environment file not found\"\n    exit 1\nfi\n\nif [ ! -f \"/deployment/.env.frontend.production\" ]; then\n    echo \"‚ùå Frontend environment file not found\"\n    exit 1\nfi\n\necho \"‚úÖ Pre-deployment checks passed\"\n\n# Deploy backend\necho \"üì¶ Deploying backend...\"\n./deployment/deploy-backend.sh\n\n# Deploy frontend\necho \"üé® Deploying frontend...\"\n./deployment/deploy-frontend.sh\n\n# Post-deployment tasks\necho \"üîß Running post-deployment tasks...\"\n\n# Setup monitoring\necho \"üìä Setting up monitoring...\"\n# Add monitoring setup commands here\n\n# Setup log aggregation\necho \"üìù Setting up log aggregation...\"\n# Add log aggregation setup here\n\n# Setup backup cron jobs\necho \"üíæ Setting up backup jobs...\"\nsudo tee /etc/cron.d/kustompedia-tryon-backup > /dev/null <<EOF\n# Daily backup at 2 AM\n0 2 * * * root /deployment/backup.sh\n\n# Weekly cleanup at 3 AM on Sunday\n0 3 * * 0 root /deployment/cleanup.sh\nEOF\n\n# Final health check\necho \"üè• Performing final health check...\"\nsleep 15\n\nif curl -f https://your-domain.com/api/health; then\n    echo \"‚úÖ Backend health check passed\"\nelse\n    echo \"‚ùå Backend health check failed\"\n    exit 1\nfi\n\nif curl -f https://your-domain.com; then\n    echo \"‚úÖ Frontend health check passed\"\nelse\n    echo \"‚ùå Frontend health check failed\"\n    exit 1\nfi\n\necho \"üéâ Complete deployment successful!\"\necho \"üìä Monitor the application at: https://your-domain.com/admin/dashboard\"\necho \"üìù Logs available at: /var/log/kustompedia-tryon/\"\necho \"üîß PM2 status: pm2 status\"\n```\n\n## Monitoring and Alerting Setup\n\n### 1. Health Check Endpoint\n\nCreate `/backend/src/routes/health.js`:\n\n```javascript\nconst express = require('express');\nconst router = express.Router();\n\n// System health check\nrouter.get('/health', async (req, res) => {\n  try {\n    const health = {\n      status: 'healthy',\n      timestamp: new Date().toISOString(),\n      uptime: process.uptime(),\n      memory: process.memoryUsage(),\n      version: process.env.npm_package_version || '1.0.0',\n      environment: process.env.NODE_ENV,\n      services: {\n        database: await checkDatabaseHealth(),\n        aiServices: await checkAIServicesHealth(),\n        fileSystem: await checkFileSystemHealth()\n      }\n    };\n    \n    // Check if any service is unhealthy\n    const unhealthyServices = Object.entries(health.services)\n      .filter(([_, status]) => status !== 'healthy');\n    \n    if (unhealthyServices.length > 0) {\n      health.status = 'degraded';\n      return res.status(503).json(health);\n    }\n    \n    res.json(health);\n  } catch (error) {\n    res.status(500).json({\n      status: 'unhealthy',\n      error: error.message,\n      timestamp: new Date().toISOString()\n    });\n  }\n});\n\n// Detailed system metrics\nrouter.get('/metrics', async (req, res) => {\n  try {\n    const metrics = {\n      timestamp: new Date().toISOString(),\n      system: {\n        uptime: process.uptime(),\n        memory: process.memoryUsage(),\n        cpu: process.cpuUsage(),\n        platform: process.platform,\n        nodeVersion: process.version\n      },\n      application: {\n        activeConnections: req.app.locals.activeConnections || 0,\n        queueLength: req.app.locals.queueLength || 0,\n        totalGenerations: req.app.locals.totalGenerations || 0,\n        successRate: req.app.locals.successRate || 0\n      }\n    };\n    \n    res.json(metrics);\n  } catch (error) {\n    res.status(500).json({\n      error: error.message,\n      timestamp: new Date().toISOString()\n    });\n  }\n});\n\nasync function checkDatabaseHealth() {\n  // Implement database health check\n  return 'healthy';\n}\n\nasync function checkAIServicesHealth() {\n  // Implement AI services health check\n  try {\n    // Test OpenAI API\n    // Test FLUX API\n    return 'healthy';\n  } catch (error) {\n    return 'unhealthy';\n  }\n}\n\nasync function checkFileSystemHealth() {\n  // Implement file system health check\n  try {\n    const fs = require('fs').promises;\n    await fs.access('/var/www/uploads', fs.constants.W_OK);\n    return 'healthy';\n  } catch (error) {\n    return 'unhealthy';\n  }\n}\n\nmodule.exports = router;\n```\n\n### 2. Monitoring Script\n\nCreate `/deployment/monitoring.sh`:\n\n```bash\n#!/bin/bash\n\n# Enhanced Try-On System Monitoring Script\n\nLOG_FILE=\"/var/log/kustompedia-tryon/monitoring.log\"\nALERT_EMAIL=\"admin@kustompedia.com\"\nHEALTH_URL=\"http://localhost:3001/api/health\"\n\n# Function to log with timestamp\nlog() {\n    echo \"$(date '+%Y-%m-%d %H:%M:%S') - $1\" >> $LOG_FILE\n}\n\n# Function to send alert\nsend_alert() {\n    local subject=\"$1\"\n    local message=\"$2\"\n    \n    echo \"$message\" | mail -s \"$subject\" $ALERT_EMAIL\n    log \"ALERT: $subject - $message\"\n}\n\n# Check application health\ncheck_health() {\n    local response=$(curl -s -w \"%{http_code}\" $HEALTH_URL)\n    local http_code=${response: -3}\n    \n    if [ \"$http_code\" != \"200\" ]; then\n        send_alert \"Application Health Check Failed\" \"HTTP Status: $http_code\\nResponse: $response\"\n        return 1\n    fi\n    \n    log \"Health check passed\"\n    return 0\n}\n\n# Check system resources\ncheck_resources() {\n    # Check CPU usage\n    local cpu_usage=$(top -bn1 | grep \"Cpu(s)\" | awk '{print $2}' | cut -d'%' -f1)\n    if (( $(echo \"$cpu_usage > 90\" | bc -l) )); then\n        send_alert \"High CPU Usage\" \"CPU usage is at $cpu_usage%\"\n    fi\n    \n    # Check memory usage\n    local mem_usage=$(free | grep Mem | awk '{printf \"%.1f\", $3/$2 * 100.0}')\n    if (( $(echo \"$mem_usage > 85\" | bc -l) )); then\n        send_alert \"High Memory Usage\" \"Memory usage is at $mem_usage%\"\n    fi\n    \n    # Check disk usage\n    local disk_usage=$(df /var/www | tail -1 | awk '{print $5}' | cut -d'%' -f1)\n    if [ \"$disk_usage\" -gt 85 ]; then\n        send_alert \"High Disk Usage\" \"Disk usage is at $disk_usage%\"\n    fi\n    \n    log \"Resource check completed - CPU: $cpu_usage%, Memory: $mem_usage%, Disk: $disk_usage%\"\n}\n\n# Check PM2 processes\ncheck_processes() {\n    local pm2_status=$(pm2 jlist | jq -r '.[] | select(.name==\"kustompedia-tryon-backend\") | .pm2_env.status')\n    \n    if [ \"$pm2_status\" != \"online\" ]; then\n        send_alert \"Application Process Down\" \"PM2 process status: $pm2_status\"\n        # Attempt to restart\n        pm2 restart kustompedia-tryon-backend\n        log \"Attempted to restart application process\"\n    fi\n}\n\n# Check log errors\ncheck_logs() {\n    local error_count=$(tail -100 /var/log/kustompedia-tryon/app.log | grep -c \"ERROR\")\n    \n    if [ \"$error_count\" -gt 10 ]; then\n        local recent_errors=$(tail -100 /var/log/kustompedia-tryon/app.log | grep \"ERROR\" | tail -5)\n        send_alert \"High Error Rate\" \"Found $error_count errors in last 100 log entries\\n\\nRecent errors:\\n$recent_errors\"\n    fi\n}\n\n# Main monitoring function\nmain() {\n    log \"Starting monitoring check\"\n    \n    check_health\n    check_resources\n    check_processes\n    check_logs\n    \n    log \"Monitoring check completed\"\n}\n\n# Run monitoring\nmain\n```\n\n## Backup and Recovery\n\n### 1. Backup Script\n\nCreate `/deployment/backup.sh`:\n\n```bash\n#!/bin/bash\n\n# Enhanced Try-On System Backup Script\n\nBACKUP_DIR=\"/var/backups/kustompedia-tryon\"\nDATE=$(date +%Y%m%d-%H%M%S)\nRETENTION_DAYS=30\n\n# Create backup directory\nmkdir -p $BACKUP_DIR\n\necho \"üóÑÔ∏è Starting backup process...\"\n\n# Backup application files\necho \"üì¶ Backing up application files...\"\ntar -czf $BACKUP_DIR/app-$DATE.tar.gz \\\n    /var/www/kustompedia-tryon-backend \\\n    /var/www/kustompedia-tryon-frontend \\\n    /etc/nginx/sites-available/kustompedia-tryon\n\n# Backup data files\necho \"üíæ Backing up data files...\"\ntar -czf $BACKUP_DIR/data-$DATE.tar.gz \\\n    /var/www/kustompedia-tryon-backend/data \\\n    /var/www/uploads\n\n# Backup configuration\necho \"‚öôÔ∏è Backing up configuration...\"\ntar -czf $BACKUP_DIR/config-$DATE.tar.gz \\\n    /var/www/kustompedia-tryon-backend/.env \\\n    /etc/nginx/sites-available/kustompedia-tryon \\\n    /etc/cron.d/kustompedia-tryon-backup\n\n# Backup logs\necho \"üìù Backing up logs...\"\ntar -czf $BACKUP_DIR/logs-$DATE.tar.gz /var/log/kustompedia-tryon\n\n# Clean old backups\necho \"üßπ Cleaning old backups...\"\nfind $BACKUP_DIR -name \"*.tar.gz\" -mtime +$RETENTION_DAYS -delete\n\necho \"‚úÖ Backup completed: $DATE\"\n\n# Log backup completion\necho \"$(date '+%Y-%m-%d %H:%M:%S') - Backup completed successfully\" >> /var/log/kustompedia-tryon/backup.log\n```\n\n### 2. Recovery Script\n\nCreate `/deployment/recovery.sh`:\n\n```bash\n#!/bin/bash\n\n# Enhanced Try-On System Recovery Script\n\nBACKUP_DIR=\"/var/backups/kustompedia-tryon\"\n\nif [ -z \"$1\" ]; then\n    echo \"Usage: $0 <backup-date>\"\n    echo \"Available backups:\"\n    ls -la $BACKUP_DIR/*.tar.gz | awk '{print $9}' | sed 's/.*\\///g' | sed 's/-.*//' | sort -u\n    exit 1\nfi\n\nBACKUP_DATE=\"$1\"\n\necho \"üîÑ Starting recovery process for backup: $BACKUP_DATE\"\n\n# Stop services\necho \"‚èπÔ∏è Stopping services...\"\npm2 stop kustompedia-tryon-backend\nsudo systemctl stop nginx\n\n# Restore application files\necho \"üì¶ Restoring application files...\"\nif [ -f \"$BACKUP_DIR/app-$BACKUP_DATE.tar.gz\" ]; then\n    sudo tar -xzf $BACKUP_DIR/app-$BACKUP_DATE.tar.gz -C /\nelse\n    echo \"‚ùå Application backup not found: app-$BACKUP_DATE.tar.gz\"\n    exit 1\nfi\n\n# Restore data files\necho \"üíæ Restoring data files...\"\nif [ -f \"$BACKUP_DIR/data-$BACKUP_DATE.tar.gz\" ]; then\n    sudo tar -xzf $BACKUP_DIR/data-$BACKUP_DATE.tar.gz -C /\nfi\n\n# Restore configuration\necho \"‚öôÔ∏è Restoring configuration...\"\nif [ -f \"$BACKUP_DIR/config-$BACKUP_DATE.tar.gz\" ]; then\n    sudo tar -xzf $BACKUP_DIR/config-$BACKUP_DATE.tar.gz -C /\nfi\n\n# Set permissions\necho \"üîê Setting permissions...\"\nsudo chown -R $USER:$USER /var/www/kustompedia-tryon-backend\nsudo chown -R www-data:www-data /var/www/kustompedia-tryon-frontend\nsudo chown -R www-data:www-data /var/www/uploads\n\n# Start services\necho \"‚ñ∂Ô∏è Starting services...\"\nsudo systemctl start nginx\npm2 start kustompedia-tryon-backend\n\n# Health check\necho \"üè• Performing health check...\"\nsleep 10\nif curl -f http://localhost:3001/api/health; then\n    echo \"‚úÖ Recovery completed successfully!\"\nelse\n    echo \"‚ùå Recovery failed - health check unsuccessful\"\n    exit 1\nfi\n\necho \"$(date '+%Y-%m-%d %H:%M:%S') - Recovery completed for backup: $BACKUP_DATE\" >> /var/log/kustompedia-tryon/recovery.log\n```\n\n## Feature Flags Configuration\n\nCreate `/backend/src/config/featureFlags.js`:\n\n```javascript\n/**\n * Feature Flags Configuration\n * Allows gradual rollout and easy rollback of new features\n */\n\nclass FeatureFlags {\n  constructor() {\n    this.flags = {\n      // Enhanced Generation Features\n      ENHANCED_GENERATION: {\n        enabled: process.env.ENABLE_ENHANCED_GENERATION === 'true',\n        rolloutPercentage: parseInt(process.env.ENHANCED_GENERATION_ROLLOUT) || 100,\n        description: 'Multi-stage generation pipeline'\n      },\n      \n      ADAPTIVE_RETRY: {\n        enabled: process.env.ENABLE_ADAPTIVE_RETRY === 'true',\n        rolloutPercentage: parseInt(process.env.ADAPTIVE_RETRY_ROLLOUT) || 100,\n        description: 'Intelligent retry system with parameter adjustment'\n      },\n      \n      QUALITY_VALIDATION: {\n        enabled: process.env.ENABLE_QUALITY_VALIDATION === 'true',\n        rolloutPercentage: parseInt(process.env.QUALITY_VALIDATION_ROLLOUT) || 100,\n        description: 'Comprehensive quality validation engine'\n      },\n      \n      // Analytics and Monitoring\n      ANALYTICS: {\n        enabled: process.env.ENABLE_ANALYTICS === 'true',\n        rolloutPercentage: parseInt(process.env.ANALYTICS_ROLLOUT) || 100,\n        description: 'Advanced analytics and metrics tracking'\n      },\n      \n      A_B_TESTING: {\n        enabled: process.env.ENABLE_A_B_TESTING === 'true',\n        rolloutPercentage: parseInt(process.env.A_B_TESTING_ROLLOUT) || 0,\n        description: 'User acceptance testing framework'\n      },\n      \n      // Performance Features\n      PARAMETER_OPTIMIZATION: {\n        enabled: process.env.ENABLE_PARAMETER_OPTIMIZATION === 'true',\n        rolloutPercentage: parseInt(process.env.PARAMETER_OPTIMIZATION_ROLLOUT) || 50,\n        description: 'Automatic parameter optimization based on results'\n      },\n      \n      ADVANCED_PROMPTS: {\n        enabled: process.env.ENABLE_ADVANCED_PROMPTS === 'true',\n        rolloutPercentage: parseInt(process.env.ADVANCED_PROMPTS_ROLLOUT) || 75,\n        description: 'Specialized prompt engineering system'\n      },\n      \n      // UI Features\n      ADMIN_DASHBOARD: {\n        enabled: process.env.ENABLE_ADMIN_DASHBOARD === 'true',\n        rolloutPercentage: 100,\n        description: 'Administrative dashboard and monitoring'\n      },\n      \n      ENHANCED_UI: {\n        enabled: process.env.ENABLE_ENHANCED_UI === 'true',\n        rolloutPercentage: parseInt(process.env.ENHANCED_UI_ROLLOUT) || 100,\n        description: 'Enhanced user interface components'\n      }\n    };\n  }\n  \n  /**\n   * Check if a feature is enabled for a user\n   * @param {string} flagName - Feature flag name\n   * @param {string} userId - User identifier (for rollout percentage)\n   * @returns {boolean} Whether feature is enabled\n   */\n  isEnabled(flagName, userId = null) {\n    const flag = this.flags[flagName];\n    \n    if (!flag) {\n      console.warn(`Unknown feature flag: ${flagName}`);\n      return false;\n    }\n    \n    if (!flag.enabled) {\n      return false;\n    }\n    \n    // Check rollout percentage\n    if (flag.rolloutPercentage < 100 && userId) {\n      const hash = this.hashUserId(userId);\n      const userPercentile = hash % 100;\n      return userPercentile < flag.rolloutPercentage;\n    }\n    \n    return flag.rolloutPercentage >= 100;\n  }\n  \n  /**\n   * Get all feature flags status\n   * @returns {Object} All feature flags with their status\n   */\n  getAllFlags() {\n    return Object.entries(this.flags).reduce((acc, [name, flag]) => {\n      acc[name] = {\n        enabled: flag.enabled,\n        rolloutPercentage: flag.rolloutPercentage,\n        description: flag.description\n      };\n      return acc;\n    }, {});\n  }\n  \n  /**\n   * Update a feature flag\n   * @param {string} flagName - Feature flag name\n   * @param {Object} updates - Updates to apply\n   */\n  updateFlag(flagName, updates) {\n    if (this.flags[flagName]) {\n      Object.assign(this.flags[flagName], updates);\n      console.log(`Updated feature flag ${flagName}:`, updates);\n    }\n  }\n  \n  /**\n   * Hash user ID for consistent rollout\n   * @param {string} userId - User identifier\n   * @returns {number} Hash value\n   */\n  hashUserId(userId) {\n    let hash = 0;\n    for (let i = 0; i < userId.length; i++) {\n      const char = userId.charCodeAt(i);\n      hash = ((hash << 5) - hash) + char;\n      hash = hash & hash; // Convert to 32-bit integer\n    }\n    return Math.abs(hash);\n  }\n}\n\nmodule.exports = new FeatureFlags();\n```\n\n## Post-Deployment Verification\n\n### 1. Verification Checklist\n\n- [ ] **Application Health**:\n  - [ ] Backend health endpoint responds (200 OK)\n  - [ ] Frontend loads successfully\n  - [ ] API endpoints are accessible\n  - [ ] WebSocket connections work (if applicable)\n\n- [ ] **Core Functionality**:\n  - [ ] Image upload works\n  - [ ] Product analysis completes\n  - [ ] Generation pipeline executes\n  - [ ] Quality validation runs\n  - [ ] Results are returned correctly\n\n- [ ] **Quality Control**:\n  - [ ] All quality tiers function\n  - [ ] Validation thresholds are applied\n  - [ ] Retry system activates when needed\n  - [ ] Error handling works properly\n\n- [ ] **Performance**:\n  - [ ] Response times are acceptable\n  - [ ] Concurrent requests handled properly\n  - [ ] Memory usage is stable\n  - [ ] No memory leaks detected\n\n- [ ] **Security**:\n  - [ ] HTTPS is enforced\n  - [ ] API keys are secured\n  - [ ] File upload restrictions work\n  - [ ] Rate limiting is active\n\n- [ ] **Monitoring**:\n  - [ ] Logs are being written\n  - [ ] Metrics are being collected\n  - [ ] Alerts are configured\n  - [ ] Health checks are running\n\n### 2. Load Testing\n\nCreate `/deployment/load-test.js`:\n\n```javascript\n// Simple load testing script\nconst axios = require('axios');\nconst FormData = require('form-data');\nconst fs = require('fs');\n\nconst BASE_URL = 'https://your-domain.com/api';\nconst CONCURRENT_REQUESTS = 5;\nconst TOTAL_REQUESTS = 50;\n\nasync function loadTest() {\n  console.log(`üß™ Starting load test: ${TOTAL_REQUESTS} requests with ${CONCURRENT_REQUESTS} concurrent`);\n  \n  const results = {\n    successful: 0,\n    failed: 0,\n    totalTime: 0,\n    responseTimes: []\n  };\n  \n  const startTime = Date.now();\n  \n  // Create batches of concurrent requests\n  for (let i = 0; i < TOTAL_REQUESTS; i += CONCURRENT_REQUESTS) {\n    const batch = [];\n    \n    for (let j = 0; j < CONCURRENT_REQUESTS && (i + j) < TOTAL_REQUESTS; j++) {\n      batch.push(makeRequest());\n    }\n    \n    const batchResults = await Promise.allSettled(batch);\n    \n    batchResults.forEach(result => {\n      if (result.status === 'fulfilled') {\n        results.successful++;\n        results.responseTimes.push(result.value.responseTime);\n      } else {\n        results.failed++;\n        console.error('Request failed:', result.reason.message);\n      }\n    });\n    \n    // Small delay between batches\n    await new Promise(resolve => setTimeout(resolve, 1000));\n  }\n  \n  results.totalTime = Date.now() - startTime;\n  \n  // Calculate statistics\n  const avgResponseTime = results.responseTimes.reduce((a, b) => a + b, 0) / results.responseTimes.length;\n  const maxResponseTime = Math.max(...results.responseTimes);\n  const minResponseTime = Math.min(...results.responseTimes);\n  \n  console.log('\\nüìä Load Test Results:');\n  console.log(`Total Requests: ${TOTAL_REQUESTS}`);\n  console.log(`Successful: ${results.successful}`);\n  console.log(`Failed: ${results.failed}`);\n  console.log(`Success Rate: ${(results.successful / TOTAL_REQUESTS * 100).toFixed(2)}%`);\n  console.log(`Total Time: ${results.totalTime}ms`);\n  console.log(`Average Response Time: ${avgResponseTime.toFixed(2)}ms`);\n  console.log(`Min Response Time: ${minResponseTime}ms`);\n  console.log(`Max Response Time: ${maxResponseTime}ms`);\n}\n\nasync function makeRequest() {\n  const startTime = Date.now();\n  \n  try {\n    // Test health endpoint\n    const response = await axios.get(`${BASE_URL}/health`, {\n      timeout: 30000\n    });\n    \n    const responseTime = Date.now() - startTime;\n    \n    if (response.status === 200) {\n      return { responseTime, status: 'success' };\n    } else {\n      throw new Error(`HTTP ${response.status}`);\n    }\n  } catch (error) {\n    throw new Error(`Request failed: ${error.message}`);\n  }\n}\n\n// Run load test\nloadTest().catch(console.error);\n```\n\n## Rollback Procedures\n\n### 1. Quick Rollback Script\n\nCreate `/deployment/rollback.sh`:\n\n```bash\n#!/bin/bash\n\n# Quick Rollback Script\n\necho \"üîÑ Starting rollback procedure...\"\n\n# Stop current services\necho \"‚èπÔ∏è Stopping services...\"\npm2 stop kustompedia-tryon-backend\n\n# Find latest backup\nLATEST_BACKUP=$(ls -t /var/backups/kustompedia-tryon/app-*.tar.gz | head -1)\n\nif [ -z \"$LATEST_BACKUP\" ]; then\n    echo \"‚ùå No backup found for rollback\"\n    exit 1\nfi\n\necho \"üì¶ Rolling back to: $LATEST_BACKUP\"\n\n# Restore from backup\nsudo tar -xzf $LATEST_BACKUP -C /\n\n# Restart services\necho \"‚ñ∂Ô∏è Restarting services...\"\npm2 start kustompedia-tryon-backend\nsudo systemctl reload nginx\n\n# Health check\necho \"üè• Performing health check...\"\nsleep 10\nif curl -f http://localhost:3001/api/health; then\n    echo \"‚úÖ Rollback completed successfully!\"\nelse\n    echo \"‚ùå Rollback failed - manual intervention required\"\n    exit 1\nfi\n```\n\n---\n\n## Support and Maintenance\n\nAfter deployment, ensure regular maintenance:\n\n### Daily Tasks\n- Monitor application health and performance\n- Check error logs for issues\n- Verify backup completion\n- Review resource usage\n\n### Weekly Tasks\n- Analyze quality metrics and trends\n- Review cost optimization opportunities\n- Update security patches\n- Clean up temporary files\n\n### Monthly Tasks\n- Review and update monitoring thresholds\n- Analyze user feedback and satisfaction\n- Plan capacity scaling if needed\n- Update documentation\n\nFor support issues, check:\n1. Application logs: `/var/log/kustompedia-tryon/`\n2. System health: `https://your-domain.com/api/health`\n3. PM2 status: `pm2 status`\n4. Nginx status: `sudo systemctl status nginx`\n\nThis deployment guide provides a comprehensive approach to deploying the Enhanced Try-On Consistency System in production with proper monitoring, backup, and recovery procedures.