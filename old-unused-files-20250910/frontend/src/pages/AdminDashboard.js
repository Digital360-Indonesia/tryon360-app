import React, { useState, useEffect } from 'react';\nimport {\n  BarChart3,\n  TrendingUp,\n  TrendingDown,\n  DollarSign,\n  Clock,\n  Users,\n  Settings,\n  AlertTriangle,\n  CheckCircle,\n  XCircle,\n  RefreshCw,\n  Download,\n  Filter,\n  Calendar,\n  Eye,\n  Target,\n  Zap\n} from 'lucide-react';\nimport { LineChart, Line, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, PieChart, Pie, Cell } from 'recharts';\n\nconst AdminDashboard = () => {\n  const [analytics, setAnalytics] = useState(null);\n  const [loading, setLoading] = useState(true);\n  const [dateRange, setDateRange] = useState({\n    startDate: new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n    endDate: new Date().toISOString().split('T')[0]\n  });\n  const [selectedModel, setSelectedModel] = useState('all');\n  const [selectedTier, setSelectedTier] = useState('all');\n  const [activeTab, setActiveTab] = useState('overview');\n  const [systemStats, setSystemStats] = useState(null);\n\n  useEffect(() => {\n    loadAnalytics();\n    loadSystemStats();\n    \n    // Refresh data every 5 minutes\n    const interval = setInterval(() => {\n      loadAnalytics();\n      loadSystemStats();\n    }, 5 * 60 * 1000);\n    \n    return () => clearInterval(interval);\n  }, [dateRange, selectedModel, selectedTier]);\n\n  const loadAnalytics = async () => {\n    try {\n      setLoading(true);\n      const params = new URLSearchParams({\n        startDate: dateRange.startDate,\n        endDate: dateRange.endDate,\n        includeDetails: 'true'\n      });\n      \n      if (selectedModel !== 'all') {\n        params.append('modelId', selectedModel);\n      }\n      \n      if (selectedTier !== 'all') {\n        params.append('qualityTier', selectedTier);\n      }\n      \n      const response = await fetch(`/api/admin/analytics?${params}`);\n      if (response.ok) {\n        const data = await response.json();\n        setAnalytics(data);\n      }\n    } catch (error) {\n      console.error('Failed to load analytics:', error);\n    } finally {\n      setLoading(false);\n    }\n  };\n\n  const loadSystemStats = async () => {\n    try {\n      const response = await fetch('/api/admin/system-stats');\n      if (response.ok) {\n        const data = await response.json();\n        setSystemStats(data);\n      }\n    } catch (error) {\n      console.error('Failed to load system stats:', error);\n    }\n  };\n\n  const exportData = async (type) => {\n    try {\n      const params = new URLSearchParams({\n        type,\n        startDate: dateRange.startDate,\n        endDate: dateRange.endDate\n      });\n      \n      const response = await fetch(`/api/admin/export?${params}`);\n      if (response.ok) {\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `${type}_${dateRange.startDate}_${dateRange.endDate}.csv`;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        document.body.removeChild(a);\n      }\n    } catch (error) {\n      console.error('Failed to export data:', error);\n    }\n  };\n\n  const StatCard = ({ title, value, change, icon: Icon, color = 'blue', format = 'number' }) => {\n    const formatValue = (val) => {\n      if (format === 'currency') return `$${val.toFixed(2)}`;\n      if (format === 'percentage') return `${(val * 100).toFixed(1)}%`;\n      if (format === 'duration') return `${Math.round(val / 1000)}s`;\n      return val.toLocaleString();\n    };\n\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <div className=\"flex items-center justify-between\">\n          <div>\n            <p className=\"text-sm font-medium text-gray-600\">{title}</p>\n            <p className=\"text-2xl font-bold text-gray-900\">{formatValue(value)}</p>\n            {change !== undefined && (\n              <div className={`flex items-center mt-1 text-sm ${\n                change >= 0 ? 'text-green-600' : 'text-red-600'\n              }`}>\n                {change >= 0 ? <TrendingUp className=\"w-4 h-4 mr-1\" /> : <TrendingDown className=\"w-4 h-4 mr-1\" />}\n                {Math.abs(change).toFixed(1)}%\n              </div>\n            )}\n          </div>\n          <div className={`p-3 rounded-full bg-${color}-100`}>\n            <Icon className={`w-6 h-6 text-${color}-600`} />\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  const QualityMetricsChart = ({ data }) => {\n    const chartData = Object.entries(data.breakdowns.byDate).map(([date, stats]) => ({\n      date,\n      successRate: stats.successCount / stats.count,\n      averageQuality: stats.averageQuality,\n      totalCost: stats.totalCost\n    }));\n\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Quality Trends</h3>\n        <ResponsiveContainer width=\"100%\" height={300}>\n          <LineChart data={chartData}>\n            <CartesianGrid strokeDasharray=\"3 3\" />\n            <XAxis dataKey=\"date\" />\n            <YAxis yAxisId=\"left\" />\n            <YAxis yAxisId=\"right\" orientation=\"right\" />\n            <Tooltip />\n            <Legend />\n            <Line \n              yAxisId=\"left\" \n              type=\"monotone\" \n              dataKey=\"successRate\" \n              stroke=\"#10b981\" \n              name=\"Success Rate\"\n            />\n            <Line \n              yAxisId=\"left\" \n              type=\"monotone\" \n              dataKey=\"averageQuality\" \n              stroke=\"#3b82f6\" \n              name=\"Avg Quality\"\n            />\n            <Line \n              yAxisId=\"right\" \n              type=\"monotone\" \n              dataKey=\"totalCost\" \n              stroke=\"#f59e0b\" \n              name=\"Daily Cost ($)\"\n            />\n          </LineChart>\n        </ResponsiveContainer>\n      </div>\n    );\n  };\n\n  const ModelPerformanceChart = ({ data }) => {\n    const chartData = Object.entries(data.breakdowns.byModel).map(([model, stats]) => ({\n      model,\n      successRate: stats.successRate,\n      averageQuality: stats.averageQuality,\n      averageCost: stats.averageCost,\n      count: stats.count\n    }));\n\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Model Performance</h3>\n        <ResponsiveContainer width=\"100%\" height={300}>\n          <BarChart data={chartData}>\n            <CartesianGrid strokeDasharray=\"3 3\" />\n            <XAxis dataKey=\"model\" />\n            <YAxis />\n            <Tooltip />\n            <Legend />\n            <Bar dataKey=\"successRate\" fill=\"#10b981\" name=\"Success Rate\" />\n            <Bar dataKey=\"averageQuality\" fill=\"#3b82f6\" name=\"Avg Quality\" />\n          </BarChart>\n        </ResponsiveContainer>\n      </div>\n    );\n  };\n\n  const QualityTierDistribution = ({ data }) => {\n    const chartData = Object.entries(data.breakdowns.byQualityTier).map(([tier, stats]) => ({\n      name: tier,\n      value: stats.count,\n      cost: stats.totalCost\n    }));\n\n    const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042'];\n\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Quality Tier Usage</h3>\n        <ResponsiveContainer width=\"100%\" height={300}>\n          <PieChart>\n            <Pie\n              data={chartData}\n              cx=\"50%\"\n              cy=\"50%\"\n              labelLine={false}\n              label={({ name, percent }) => `${name} ${(percent * 100).toFixed(0)}%`}\n              outerRadius={80}\n              fill=\"#8884d8\"\n              dataKey=\"value\"\n            >\n              {chartData.map((entry, index) => (\n                <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />\n              ))}\n            </Pie>\n            <Tooltip />\n          </PieChart>\n        </ResponsiveContainer>\n      </div>\n    );\n  };\n\n  const RecentGenerations = ({ generations }) => {\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">Recent Generations</h3>\n        <div className=\"overflow-x-auto\">\n          <table className=\"min-w-full divide-y divide-gray-200\">\n            <thead className=\"bg-gray-50\">\n              <tr>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  Status\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  Model\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  Quality\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  Duration\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  Cost\n                </th>\n                <th className=\"px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider\">\n                  Attempts\n                </th>\n              </tr>\n            </thead>\n            <tbody className=\"bg-white divide-y divide-gray-200\">\n              {generations.slice(0, 10).map((gen, index) => (\n                <tr key={index}>\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <div className=\"flex items-center\">\n                      {gen.success ? (\n                        <CheckCircle className=\"w-5 h-5 text-green-600\" />\n                      ) : (\n                        <XCircle className=\"w-5 h-5 text-red-600\" />\n                      )}\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                    {gen.modelId}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap\">\n                    <div className=\"flex items-center\">\n                      <div className=\"text-sm text-gray-900\">\n                        {Math.round(gen.finalQuality * 100)}%\n                      </div>\n                      <div className={`ml-2 px-2 py-1 text-xs rounded-full ${\n                        gen.finalQuality >= 0.8 ? 'bg-green-100 text-green-800' :\n                        gen.finalQuality >= 0.6 ? 'bg-yellow-100 text-yellow-800' :\n                        'bg-red-100 text-red-800'\n                      }`}>\n                        {gen.qualityTier}\n                      </div>\n                    </div>\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                    {Math.round(gen.duration / 1000)}s\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                    ${gen.cost.toFixed(3)}\n                  </td>\n                  <td className=\"px-6 py-4 whitespace-nowrap text-sm text-gray-900\">\n                    {gen.attempts}\n                  </td>\n                </tr>\n              ))}\n            </tbody>\n          </table>\n        </div>\n      </div>\n    );\n  };\n\n  const SystemHealth = ({ stats }) => {\n    if (!stats) return null;\n\n    return (\n      <div className=\"bg-white rounded-lg shadow-md p-6\">\n        <h3 className=\"text-lg font-semibold text-gray-900 mb-4\">System Health</h3>\n        <div className=\"grid grid-cols-2 md:grid-cols-4 gap-4\">\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-gray-900\">\n              {stats.performance?.averageCpu?.toFixed(1) || 0}%\n            </div>\n            <div className=\"text-sm text-gray-600\">CPU Usage</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-gray-900\">\n              {Math.round((stats.performance?.averageMemory || 0) / 1024 / 1024)}MB\n            </div>\n            <div className=\"text-sm text-gray-600\">Memory</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-gray-900\">\n              {stats.queue?.active || 0}\n            </div>\n            <div className=\"text-sm text-gray-600\">Active Jobs</div>\n          </div>\n          <div className=\"text-center\">\n            <div className=\"text-2xl font-bold text-gray-900\">\n              {Math.round(stats.performance?.averageResponseTime || 0)}ms\n            </div>\n            <div className=\"text-sm text-gray-600\">Response Time</div>\n          </div>\n        </div>\n      </div>\n    );\n  };\n\n  if (loading && !analytics) {\n    return (\n      <div className=\"min-h-screen bg-gray-50 flex items-center justify-center\">\n        <div className=\"flex items-center space-x-2\">\n          <RefreshCw className=\"w-6 h-6 animate-spin text-orange-600\" />\n          <span className=\"text-lg text-gray-600\">Loading dashboard...</span>\n        </div>\n      </div>\n    );\n  }\n\n  return (\n    <div className=\"min-h-screen bg-gray-50\">\n      {/* Header */}\n      <div className=\"bg-white shadow-sm border-b\">\n        <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8\">\n          <div className=\"flex items-center justify-between h-16\">\n            <div className=\"flex items-center space-x-3\">\n              <BarChart3 className=\"w-8 h-8 text-orange-600\" />\n              <h1 className=\"text-2xl font-bold text-gray-900\">Admin Dashboard</h1>\n            </div>\n            \n            <div className=\"flex items-center space-x-4\">\n              <button\n                onClick={() => exportData('analytics')}\n                className=\"flex items-center space-x-2 px-3 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 transition-colors\"\n              >\n                <Download className=\"w-4 h-4\" />\n                <span>Export</span>\n              </button>\n              \n              <button\n                onClick={loadAnalytics}\n                className=\"p-2 text-gray-500 hover:text-gray-700 transition-colors\"\n              >\n                <RefreshCw className={`w-5 h-5 ${loading ? 'animate-spin' : ''}`} />\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n\n      <div className=\"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8\">\n        {/* Filters */}\n        <div className=\"bg-white rounded-lg shadow-md p-6 mb-8\">\n          <div className=\"flex items-center space-x-2 mb-4\">\n            <Filter className=\"w-5 h-5 text-gray-600\" />\n            <h3 className=\"text-lg font-semibold text-gray-900\">Filters</h3>\n          </div>\n          \n          <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4\">\n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                Start Date\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.startDate}\n                onChange={(e) => setDateRange(prev => ({ ...prev, startDate: e.target.value }))}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500\"\n              />\n            </div>\n            \n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                End Date\n              </label>\n              <input\n                type=\"date\"\n                value={dateRange.endDate}\n                onChange={(e) => setDateRange(prev => ({ ...prev, endDate: e.target.value }))}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500\"\n              />\n            </div>\n            \n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                Model\n              </label>\n              <select\n                value={selectedModel}\n                onChange={(e) => setSelectedModel(e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500\"\n              >\n                <option value=\"all\">All Models</option>\n                <option value=\"johny\">Johny</option>\n                <option value=\"nyoman\">Nyoman</option>\n                <option value=\"isabella\">Isabella</option>\n              </select>\n            </div>\n            \n            <div>\n              <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                Quality Tier\n              </label>\n              <select\n                value={selectedTier}\n                onChange={(e) => setSelectedTier(e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500\"\n              >\n                <option value=\"all\">All Tiers</option>\n                <option value=\"basic\">Basic</option>\n                <option value=\"standard\">Standard</option>\n                <option value=\"premium\">Premium</option>\n                <option value=\"ultra\">Ultra</option>\n              </select>\n            </div>\n          </div>\n        </div>\n\n        {analytics && (\n          <>\n            {/* Summary Stats */}\n            <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8\">\n              <StatCard\n                title=\"Total Generations\"\n                value={analytics.summary.totalGenerations}\n                icon={Zap}\n                color=\"blue\"\n              />\n              \n              <StatCard\n                title=\"Success Rate\"\n                value={analytics.summary.successRate}\n                icon={Target}\n                color=\"green\"\n                format=\"percentage\"\n              />\n              \n              <StatCard\n                title=\"Total Cost\"\n                value={analytics.summary.totalCost}\n                icon={DollarSign}\n                color=\"yellow\"\n                format=\"currency\"\n              />\n              \n              <StatCard\n                title=\"Avg Duration\"\n                value={analytics.summary.averageDuration}\n                icon={Clock}\n                color=\"purple\"\n                format=\"duration\"\n              />\n            </div>\n\n            {/* System Health */}\n            <div className=\"mb-8\">\n              <SystemHealth stats={systemStats} />\n            </div>\n\n            {/* Charts */}\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8\">\n              <QualityMetricsChart data={analytics} />\n              <ModelPerformanceChart data={analytics} />\n            </div>\n\n            <div className=\"grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8\">\n              <QualityTierDistribution data={analytics} />\n              <RecentGenerations generations={analytics.details?.generations || []} />\n            </div>\n          </>\n        )}\n      </div>\n    </div>\n  );\n};\n\nexport default AdminDashboard;